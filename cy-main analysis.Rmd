---
title: "Main Analysis"
author: "Chunran Yao(cy2511)"
date: "11/20/2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 10)
```

```{r warning=FALSE}
library(GGally)
library(gridExtra)
library(ggpubr)
library(tidyverse)
library(dplyr)
mycolor <- c("#404788FF")
```


# Main Analysis
```{r}
data <- read.csv("H1B_26variable.csv")
```

## What can influence the CASE_STATUS?
### Does annual wage influence the CASE_STATUS?
Salary is a significant attribute for any employee. So firstly, we want to know if salary will influence case status.
```{r}
ggplot(data, aes(x = data$CASE_STATUS, y = data$ANNUAL_WAGE))+
  geom_boxplot(fill = mycolor)+
  ggtitle("annual wage vs. case status")+
  xlab("case status")+
  ylab("annual wage")+
  theme(plot.title = element_text(hjust = 0.5))
```

However, there seem to be outliers in salary. According to this plot, there is an annual wage of 100000000 in the denied group, which is impossible.
By carefully cleaning the data, we can find more impossible data in the annual wage, and we create a new variable called "entry_mistake" to flag whether the annual wage is right. 

```{r}
ggplot(data, aes(x = ENTRY_MISTAKE,fill = CASE_STATUS))+
  geom_bar(position = "fill")+
  ggtitle("entry mistake vs.case status")+
  xlab("case status")+
  ylab("entry mistake")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_viridis_d()
```

Obviously, entry mistake has a great influence on case_status. Most of the applications without the mistakes in annual wage are certified; However, when there are mistakes in annual wage, most of the applications are either withdrawn or denied. It is rare to certify these applications compared to those without mistakes. Therefore, the entry mistakes in applications will highly decrease the chance of certification. If an applicant submits a wrong annual wage, we advise him/her withdraws it him/herself, otherwise, it is probably be denied.

And let's draw a new case_status vs. annual wage plot without an entry mistake.
```{r}
newdata <- data[which(data$ENTRY_MISTAKE == FALSE),]
ggplot(newdata, aes(x = newdata$CASE_STATUS, y = newdata$ANNUAL_WAGE))+
  geom_boxplot(fill = mycolor, alpha = 0.5)+
  ggtitle("annual wage vs. case status")+
  xlab("case status")+
  ylab("annual wage")+
  theme(plot.title = element_text(hjust = 0.5))
```
After dropping the data with entry mistakes, the plot becomes more clear but it is not enough. There are still some outliers far from others: there are applicants who get more than $7,000,000 a year.
To better display the distribution of annual wage with different case status, limiting the salary within $300,000 (more than 99% annual wages are under 300,000).

```{r}
newdata <- data[which(data$ENTRY_MISTAKE == FALSE & data$ANNUAL_WAGE<300000),]
ggplot(newdata, aes(x = newdata$CASE_STATUS, y = newdata$ANNUAL_WAGE))+
  geom_boxplot(fill = mycolor, alpha = 0.5)+
  ggtitle("annual wage vs. case status")+
  xlab("case status")+
  ylab("annual wage")+
  theme(plot.title = element_text(hjust = 0.5))
```
Now the plot is much more clear. The median and the quartiles of different groups are generally the same, with only small differences. Specifically, the median is 87500 for certified, 80000 for certified-withdrawn, 79789 for denied, and 84000 for withdrawn.
Therefore, getting more salary may slightly increase the chance of certification. But it is only slightly.

```
newdata <- data[which(data$ENTRY_MISTAKE == FALSE),]
case_wage_mean <- group_by(newdata,newdata$CASE_STATUS) %>% summarise_at(vars(ANNUAL_WAGE),mean)
annaualWageH1bPlot3 <- ggplot(case_wage_mean, aes(x = case_wage_mean$`newdata$CASE_STATUS`,y = case_wage_mean$ANNUAL_WAGE))+
  geom_bar(stat = "identity", fill = mycolor)+
  ggtitle("Annual wage(mean) vs. case status")+
  xlab("case status")+
  ylab("average annual wage")+
  theme(plot.title = element_text(hjust = 0.5))
case_wage_median <- group_by(newdata,newdata$CASE_STATUS) %>% summarise_at(vars(ANNUAL_WAGE),median)
annaualWageH1bPlot4 <- ggplot(case_wage_median, aes(x = case_wage_median$`newdata$CASE_STATUS`,y = case_wage_median$ANNUAL_WAGE))+
  geom_bar(stat = "identity", fill = mycolor)+
  ggtitle("Annual wage(median) vs. case status")+
  xlab("case status")+
  ylab("median of annual wage")+
  theme(plot.title = element_text(hjust = 0.5))
grid.arrange(annaualWageH1bPlot3, annaualWageH1bPlot4, ncol = 2, nrow = 1)
```

### Does occupation influence case status?
It is reasonable to connect occupations with case status. Some occupations may be helpful for the H1B applications, others may be an obstruction, such as the military occupations.
SOC_CODE is the Occupational code associated with the job, so we can use SOC_CODE to represent the occupations.
```{r fig.width=8}
data$MAJOR_SOC_CODE <- as.factor(data$MAJOR_SOC_CODE)
SOCH1bPlot1 <- ggplot(data[!is.na(data$MAJOR_SOC_CODE), ], aes(x=MAJOR_SOC_CODE,fill=CASE_STATUS)) +
  geom_bar(position = "fill")+
  scale_fill_viridis_d()+
  ylab("fraction")+
  xlab("Major SOC CODE")+
  theme(legend.position = "top",plot.title = element_text(hjust = 0.5))
SOCH1bPlot2 <- ggplot(data[!is.na(data$MAJOR_SOC_CODE), ], aes(x=MAJOR_SOC_CODE,fill=CASE_STATUS)) +
  geom_bar()+
  scale_fill_viridis_d()+
  ylab("number")+
  xlab("Major SOC CODE")+
  theme(legend.position = "top",plot.title = element_text(hjust = 0.5))
SOCH1bPlot <- ggarrange(SOCH1bPlot1, SOCH1bPlot2, common.legend = TRUE)
annotate_figure(SOCH1bPlot,top = text_grob("Major SOC CODE vs. case status"))
```

According to the left plot, it seems that there is some association between the major SOC CODE and CASE_STATUS. For example, all the cases with MAJOR_SOC_CODE as 40 are certified. However, combining the right plot, which draws the number of each SOC_CODE with different status instead of the fraction, it is clear to see that there are little cases whose SOC_CODE are from 31 to 53. In fact, there is **only one** case whose MAJOR_SOC_CODE is 40. So the sample is too small and we can not draw a conclusion depending on these small samples.                                                          
From the right plot, we can see that many applicants having a SOC CODE from 11 to 29, especially 15. There are so many applications having Computer and Mathematical Occupations!                          
Thus, it is more reasonable to compare the cases with MAJOR_SOC_CODE from 11 to 29, where there are more cases. It is obvious that there are only small fluctuations. The certification of applications whose SOC CODE is 19 (Life, Physical, and Social Science Occupations) are more likely to be withdrawn by their employers. In general, the SOC_CODE (major) will not influence whether the H1B application will be certified or not. 
That is, the occupation of the applications will not influence case status.

### Does industry influence case status?
The association between industry and case status is another reasonable hypothesis. Some hypothesis may have priority while others not. Since NAICS CODE is the Industry code, we use NAICS CODE to represent the industry.

```{r fig.width=8}
data$MAJOR_NAICS_CODE <- as.factor(data$MAJOR_NAICS_CODE)
NaicsH1bPlot1 <- ggplot(data, aes(x=MAJOR_NAICS_CODE,fill=CASE_STATUS)) +
  geom_bar(position = "fill")+
  scale_fill_viridis_d()+
  ylab("fraction")+
  xlab("Major NAICS CODE ")+
  theme(legend.position = "top",plot.title = element_text(hjust = 0.5))
NaicsH1bPlot2 <- ggplot(data, aes(x=MAJOR_NAICS_CODE,fill=CASE_STATUS)) +
  geom_bar()+
  scale_fill_viridis_d()+
  ylab("number")+
  xlab("Major NAICS CODE")+
  theme(legend.position = "top",plot.title = element_text(hjust = 0.5))
#grid.arrange(NaicsH1bPlot1, NaicsH1bPlot2, ncol = 2, nrow = 1)
NaicsH1bPlot <- ggarrange(NaicsH1bPlot1, NaicsH1bPlot2, common.legend = TRUE)
annotate_figure(NaicsH1bPlot,top = text_grob("Major NAICS CODE vs. case status"))
```

NAICS CODE shares the same pattern with SOC CODE: there is one code outweigh others. In SOC CODE, 15 (Computer and Mathematical Occupations) outweighs others; in NAICS CODE, 54 (Professional, Scientific, and Technical Services) outweighs other.
Combining the total number and the fraction of NAICS CODE with different case status, applications with NAICS code as 45 (Retail Trade) are more likely to be certified and the certification of applicants with 61 (Educational Services) tend to be withdrawn. In general, NAICS CODE doesn't influence case status greatly. That is, the industry will not influence the case status greatly.

And more certified-withdrawn in Educational Services is corresponding with the more certified-withdrawn in Life, Physical, and Social Science Occupations.                          
**It is strange.**

```{r}
#strange1 <- data[which(data$MAJOR_NAICS_CODE == "61" & data$CASE_STATUS == "CERTIFIED-WITHDRAWN"),]
#strange2 <- data[which(data$MAJOR_SOC_CODE == "19" & data$CASE_STATUS == "CERTIFIED-WITHDRAWN"),]
SOC19 <- data[which(data$MAJOR_SOC_CODE == "19"),]
SOC19 <- mutate(SOC19, SOC_CODE_4 = str_sub(SOC19$SOC_CODE,4,7))
SOC19$SOC_CODE_4 <- as.factor(SOC19$SOC_CODE_4)

SOC19Plot1 <- ggplot(SOC19, aes(x = SOC_CODE_4, fill = CASE_STATUS))+
  geom_bar()+
  theme(axis.text.x = element_text(angle=90))+
  scale_fill_viridis_d()
SOC19Plot2 <- ggplot(SOC19, aes(x = SOC_CODE_4, fill = CASE_STATUS))+
  geom_bar(position = "fill")+
  theme(axis.text.x = element_text(angle=90))+
  scale_fill_viridis_d()
grid.arrange(SOC19Plot1,SOC19Plot2)
```

```{r}
NAICS61 <- data[which(data$MAJOR_NAICS_CODE == "61"),]
NAICS61Plot1 <- ggplot(NAICS61, aes(x =as.factor(NAICS_CODE), fill = CASE_STATUS))+
  geom_bar()+
  theme(axis.text.x = element_text(angle=90))+
  scale_fill_viridis_d()
NAICS61Plot2 <- ggplot(NAICS61, aes( x =as.factor(NAICS_CODE), fill = CASE_STATUS))+
  geom_bar(position = "fill")+
  theme(axis.text.x = element_text(angle=90))+
  scale_fill_viridis_d()
grid.arrange(NAICS61Plot1,NAICS61Plot2)
```

### Does H1B dependent influence case status?
H1B-dependent is an important field in this dataset. It is used to describe the applicants' employers. Employers who hire ‘too many’ H1B workers are labeled H1B Dependent Employers.                                  
Whether or not an employer is H1B-dependent is mainly determined by the size of the company:                           
- 1-25 full-time employees of which at least 8 are H1B workers.
- 26 to 50 full-time employees of which at least 13 are H1B workers.
- 51 or more full-time employees of which 15% or more are H1B workers.
Intuitively, H1B dependent is associated with the case status: the applicants are more likely to be certified if their employers are H1B dependent.
```{r}
dependentH1b <- group_by(data[!is.na(data$H1B_DEPENDENT),],H1B_DEPENDENT, CASE_STATUS) %>% summarise(number = n())
ggplot(data = dependentH1b, aes(x = H1B_DEPENDENT, y = number, fill = CASE_STATUS))+
  geom_bar(stat = "identity", position = "fill")+
  scale_fill_viridis_d()+
  ylab("fraction")+
  xlab("H1B dependent")+
  ggtitle("H1B dependent vs. case status")+
  theme(plot.title = element_text(hjust = 0.5))
```

Although the association is not so strong, we cannot say they are irrelevant. The fraction of certified applications is more if the employers are H1B dependent. And if the employer is not H1B dependent, the application is more likely to be denied.
Therefore, to increase the chance of certification and decrease the chance of denial, maybe it is a good idea to work in an H1B-dependent company.

## Does wait time influence case status?
```{r}
ggplot(data, aes(x = data$CASE_STATUS, y = data$WAIT_TIME))+
  geom_boxplot(fill = mycolor)+
  ggtitle("wait time vs. case status")+
  xlab("case status")+
  ylab("wait time")+
  theme(plot.title = element_text(hjust = 0.5))
```
Surprisingly, the wait time with different case status varies a lot. The median of wait time with certified-withdrawn is much more than those with other statuses; Specifically, the median of the wait time in certified, the denied and the withdrawn group is around 0.There is no "large number" in certified and denied, while there is more long wait time in other groups.

To display them more clear:
```{r}
ggplot(data, aes(x = data$WAIT_TIME, y =data$CASE_STATUS )) +
  geom_point(color = mycolor, alpha = 0.5) + 
  facet_wrap(~ CASE_STATUS, ncol = 1, scales = "free") +     
  ylab("case status")+
  xlab("wait time")
```
It is a scatter plot of wait time with different case status. From this plot, only the wait time of certified-withdrawn and withdrawn can exceed 10. It seems weird, but it is actually reasonable. Considering the meaning of wait time, it is the time between case submitted and decision date. The decision means the date on which the last significant event or decision was recorded; And withdrawn is a significant event. Now it is clear: the department will make the decision no more than 10 days, whether is CERTIFIED or DENIED; But the applications can be withdrawn even after 6 years submitting the case.  

