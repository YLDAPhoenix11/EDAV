---
title: "Final project"
author: "Alpha Lu"
date: "11/6/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, echo=T,eval=TRUE,warning=FALSE,cache=FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache = TRUE)
```
#data cleaning process


## NAICS
- by: Alpha Lu
  input: data (H1B_clean)                                                                                               
  output: d                                             
  add new variable: sector (num);description (charactor)
  
  
  
```{r,fig.width=20,fig.height=20}

library(ggplot2)
library(tidyverse)
#analyze Salary by federal occupational code
data <- read.csv(file="/Users/alphalu/Desktop/EDAV/finalproject/data.csv")
library(tidyverse)
#extract several columns into dataframe NN
NN <- data.frame(data$CASE_NUMBER,data$CASE_STATUS,data$SOC_CODE,data$SOC_NAME,data$NAICS_CODE,data$WORKSITE_CITY,data$WORKSITE_COUNTY,data$WORKSITE_STATE,data$WORKSITE_POSTAL_CODE)
#create a new column digits two store two-digit sector number
NN$sector <- 0
NN[is.na(NN)] <- 0
NN$description <- "0"
#subset NN according to data.NAICS_CODE
d2 <- subset(NN,data.NAICS_CODE <99 , 
select=c(data.CASE_NUMBER,data.CASE_STATUS,data.SOC_CODE,data.SOC_NAME,data.NAICS_CODE,sector,description,data.WORKSITE_CITY,data.WORKSITE_COUNTY,data.WORKSITE_STATE,data.WORKSITE_POSTAL_CODE))
d2$sector<- d2$data.NAICS_CODE

d3 <- subset(NN,data.NAICS_CODE <999 & NN$data.NAICS_CODE >99, 
select=c(data.CASE_NUMBER,data.CASE_STATUS,data.SOC_CODE,data.SOC_NAME,data.NAICS_CODE,sector,description,data.WORKSITE_CITY,data.WORKSITE_COUNTY,data.WORKSITE_STATE,data.WORKSITE_POSTAL_CODE))
d3$sector<- d3$data.NAICS_CODE%/%10

d4 <- subset(NN,data.NAICS_CODE <9999 & NN$data.NAICS_CODE >999, 
select=c(data.CASE_NUMBER,data.CASE_STATUS,data.SOC_CODE,data.SOC_NAME,data.NAICS_CODE,sector,description,data.WORKSITE_CITY,data.WORKSITE_COUNTY,data.WORKSITE_STATE,data.WORKSITE_POSTAL_CODE))
d4$sector<- d4$data.NAICS_CODE%/%100

d5 <- subset(NN,data.NAICS_CODE <99999 & NN$data.NAICS_CODE >9999, 
select=c(data.CASE_NUMBER,data.CASE_STATUS,data.SOC_CODE,data.SOC_NAME,data.NAICS_CODE,sector,description,data.WORKSITE_CITY,data.WORKSITE_COUNTY,data.WORKSITE_STATE,data.WORKSITE_POSTAL_CODE))
d5$sector<- d5$data.NAICS_CODE%/%1000

d6 <- subset(NN,NN$data.NAICS_CODE >99999, 
select=c(data.CASE_NUMBER,data.CASE_STATUS,data.SOC_CODE,data.SOC_NAME,data.NAICS_CODE,sector,description,data.WORKSITE_CITY,data.WORKSITE_COUNTY,data.WORKSITE_STATE,data.WORKSITE_POSTAL_CODE))
d6$sector<- d6$data.NAICS_CODE%/%10000


#merge d2 d3 d4 d5 d6 into d
d <- rbind(d2,d3,d4,d5,d6)
#d<- setNames(d,c("SOC_NAME", "NAICS_CODE","sector"))

d$description[d$sector== 11 ]= "Agriculture, Forestry, Fishing and Hunting (not covered in economic census)"
d$description[d$sector== 21 ]= "Mining, Quarrying, and Oil and Gas Extraction"
d$description[d$sector== 22 ]= "Utilities"
d$description[d$sector== 23 ]="Construction"
d$description[d$sector== 31 ]="Manufacturing"
d$description[d$sector== 32 ]="Manufacturing"
d$description[d$sector== 33 ]="Manufacturing"
d$description[d$sector== 42 ]="Wholesale Trade"
d$description[d$sector== 44 ]="Retail Trade"
d$description[d$sector== 45 ]="Retail Trade"
d$description[d$sector== 48 ]="Transportation and Warehousing"
d$description[d$sector== 49 ]="Transportation and Warehousing"
d$description[d$sector== 51 ]="Information"
d$description[d$sector== 52 ]="Finance and Insurance"
d$description[d$sector== 53 ]="Real Estate and Rental and Leasing"
d$description[d$sector== 54 ]="Professional, Scientific, and Technical Services"
d$description[d$sector== 55 ]="Management of Companies and Enterprises"
d$description[d$sector== 56 ]="Administrative and Support and Waste Management and Remediation Services"
d$description[d$sector== 61 ]="Educational Services"
d$description[d$sector== 62 ]="Health Care and Social Assistance"
d$description[d$sector== 71 ]="Arts, Entertainment, and Recreation"
d$description[d$sector== 72 ]="Accommodation and Food Services"
d$description[d$sector== 81 ]="Other Services (except Public Administration)"
d$description[d$sector== 92 ]="Public Administration (not covered in economic census)"

#if you want to use part of the new vairables, uncomment here
#new_col <- data.frame(d$data.NAICS_CODE,d$sector,d$description)
#names(new_col) <- c("NAICS_CODE","sector","description")
#new_col[is.na(new_col)] <- 0

#CARETE NEW VARIABLE: sector
data<-mutate(data, sector = d$sector)
data<- mutate(data,description=d$description)
```



## SOC_CODE
- by: Chunran Yao
  input: data                          
  output: data                                    
  add new variable: SOC_major (factor)

```{r}

data$SOC_CODE <- as.character(data$SOC_CODE)
data$SOC_CODE[which((data$SOC_CODE == "") & (data$JOB_TITLE == "JUNIOR ARCHITECT"))] <- "17-1011"
data$SOC_CODE[which((data$SOC_CODE == "") & (data$JOB_TITLE == "DRIVER"))] <- "53-0000"
#data <- data[which(data$SOC_CODE!=""),]   #if you want to drop NAs, uncomment this line

SOC_CODE_pattern <- "([1-5][0-9])[-]([0-9]{4})"
data$SOC_CODE <- ifelse(str_detect(data$SOC_NAME, SOC_CODE_pattern)==TRUE,str_match(data$SOC_NAME, SOC_CODE_pattern)[1], data$SOC_CODE)
data$SOC_CODE[which(data$SOC_CODE == "25/1071")] <- "25-1071"
data$SOC_CODE[which(data$SOC_CODE == "532011")] <- "53-2011"
data$SOC_CODE[which(data$SOC_CODE == "71-2141")] <- "17-2141"
data$SOC_CODE[which(data$SOC_CODE == "291069")] <- "29-1069"
data$SOC_CODE[which(data$SOC_CODE == "132011")] <- "13-2011"
data$SOC_CODE[which(data$SOC_CODE == "132051")] <- "13-2051"
data$SOC_CODE[which(data$SOC_CODE == "13-181.01")] <- "13-1081"
data$SOC_CODE[which(data$SOC_CODE == "151132")] <- "15-1132"
data$SOC_CODE[which(data$SOC_CODE == "29.1062")] <- "29-1062"
data$SOC_CODE[which(data$SOC_CODE == "43.9111.01")] <- "43-9111.01"
data$SOC_CODE[which(data$SOC_CODE == "15.1199.09")] <- "15-1199"

#CARETE NEW VARIABLE: SOC_CODE_major
data<-mutate(data, SOC_CODE_major = str_sub(data$SOC_CODE,1,2))
data$SOC_CODE_major <-as.factor(data$SOC_CODE_major)
data$SOC_CODE <- as.character(data$SOC_CODE)
data$SOC_CODE[which((data$SOC_CODE == "") & (data$JOB_TITLE == "JUNIOR ARCHITECT"))] <- "17-1011"
data$SOC_CODE[which((data$SOC_CODE == "") & (data$JOB_TITLE == "DRIVER"))] <- "53-0000"
#data <- data[which(data$SOC_CODE!=""),]   #if you want to drop NAs, uncomment this line

SOC_CODE_pattern <- "([1-5][0-9])[-]([0-9]{4})"
data$SOC_CODE <- ifelse(str_detect(data$SOC_NAME, SOC_CODE_pattern)==TRUE,str_match(data$SOC_NAME, SOC_CODE_pattern)[1], data$SOC_CODE)
data$SOC_CODE[which(data$SOC_CODE == "25/1071")] <- "25-1071"
data$SOC_CODE[which(data$SOC_CODE == "532011")] <- "53-2011"
data$SOC_CODE[which(data$SOC_CODE == "71-2141")] <- "17-2141"
data$SOC_CODE[which(data$SOC_CODE == "291069")] <- "29-1069"
data$SOC_CODE[which(data$SOC_CODE == "132011")] <- "13-2011"
data$SOC_CODE[which(data$SOC_CODE == "132051")] <- "13-2051"
data$SOC_CODE[which(data$SOC_CODE == "13-181.01")] <- "13-1081"
data$SOC_CODE[which(data$SOC_CODE == "151132")] <- "15-1132"
data$SOC_CODE[which(data$SOC_CODE == "29.1062")] <- "29-1062"
data$SOC_CODE[which(data$SOC_CODE == "43.9111.01")] <- "43-9111.01"
data$SOC_CODE[which(data$SOC_CODE == "15.1199.09")] <- "15-1199"

#CARETE NEW VARIABLE: SOC_CODE_major
data<-mutate(data, SOC_CODE_major = str_sub(data$SOC_CODE,1,2))
data$SOC_CODE_major <-as.factor(data$SOC_CODE_major)

```






## Standardize wage rate & wait time
- by: Ze Chen
  input: H1B (data)                                  
  output: H1B_clean                                 
  add new variable: Wait_Time (numeric); Entry_Mistake (logistic); annual_wage (numeric)
```{r}
H1B <- data

#convert variable "WAGE_RATE_OF_PAY_FROM" from factor to numeric
class(H1B$WAGE_RATE_OF_PAY_FROM)
H1B$WAGE_RATE_OF_PAY_FROM <- as.numeric(gsub(",","",H1B$WAGE_RATE_OF_PAY_FROM))
H1B$WAGE_RATE_OF_PAY_FROM <- as.numeric(as.character(H1B$WAGE_RATE_OF_PAY_FROM))

#Standardize wage to annual wage
hour <- H1B %>% filter(WAGE_UNIT_OF_PAY == "Hour" & WAGE_RATE_OF_PAY_FROM<1000)%>% mutate(annual_wage = WAGE_RATE_OF_PAY_FROM*1780)
hour2 <- H1B %>% filter(WAGE_UNIT_OF_PAY == "Hour" & WAGE_RATE_OF_PAY_FROM>10000)%>% mutate(annual_wage = WAGE_RATE_OF_PAY_FROM)#entry mistake: enter annual wage as hour wage
hour3 <- H1B %>% filter(WAGE_UNIT_OF_PAY == "Hour" & WAGE_RATE_OF_PAY_FROM==5850.00)%>% mutate(annual_wage = WAGE_RATE_OF_PAY_FROM*12) #entry mistake: enter month wage as hour wage

week <- H1B %>% filter(WAGE_UNIT_OF_PAY == "Week"& WAGE_RATE_OF_PAY_FROM<70000) %>%  mutate(annual_wage= WAGE_RATE_OF_PAY_FROM*51) 
week2 <- H1B %>% filter(WAGE_UNIT_OF_PAY == "Week"& WAGE_RATE_OF_PAY_FROM>70000) %>%  mutate(annual_wage= WAGE_RATE_OF_PAY_FROM) #entry mistake: enter annual wage as week wage

bi_weekly <- H1B %>%  filter(WAGE_UNIT_OF_PAY == "Bi-Weekly")%>% mutate(annual_wage= WAGE_RATE_OF_PAY_FROM*25)
month <- H1B %>%  filter(WAGE_UNIT_OF_PAY == "Month") %>% mutate(annual_wage =WAGE_RATE_OF_PAY_FROM*12)
year <- H1B %>% filter(WAGE_UNIT_OF_PAY == "Year")%>% mutate(annual_wage = WAGE_RATE_OF_PAY_FROM)
na <-H1B %>% filter(WAGE_UNIT_OF_PAY == "")%>% mutate(annual_wage = WAGE_RATE_OF_PAY_FROM)

merge1 <- merge(hour,week,all=TRUE)
merge2 <- merge(merge1, bi_weekly, all = TRUE)
merge3 <- merge(merge2, month, all = TRUE)
merge4 <- merge(merge3, year, all = TRUE)
merge5 <- merge(merge4, na, all = TRUE)
merge6 <- merge(merge5, hour2, all = TRUE)
merge7 <- merge(merge6, hour3, all = TRUE)
merge8 <- merge(merge7, week2, all = TRUE)

#create new dummy variable "Entry_Mistake", representing entry mistake of WAGE_RATE_OF_PAY_FROM
H1B_clean <- merge8 %>% mutate(Entry_Mistake = case_when(
  WAGE_UNIT_OF_PAY == "Hour" & WAGE_RATE_OF_PAY_FROM>1000 ~ TRUE, 
  WAGE_UNIT_OF_PAY == "Week"& WAGE_RATE_OF_PAY_FROM>70000 ~ TRUE,
  WAGE_UNIT_OF_PAY == "Year"& WAGE_RATE_OF_PAY_FROM>100000000 ~ TRUE))

H1B_clean$Entry_Mistake[is.na(H1B_clean$Entry_Mistakes)]=FALSE
H1B_clean$Entry_Mistake <- H1B_clean$Entry_Mistake %>% replace_na(FALSE)

#convert date variable from character to date class
H1B_clean$CASE_SUBMITTED <- as.Date(H1B_clean$CASE_SUBMITTED, format = "%m/%d/%y")
H1B_clean$DECISION_DATE <- as.Date(H1B_clean$DECISION_DATE, format = "%m/%d/%y")
H1B_clean$EMPLOYMENT_START_DATE <- as.Date(H1B_clean$EMPLOYMENT_START_DATE, format = "%m/%d/%y")
H1B_clean$EMPLOYMENT_END_DATE <- as.Date(H1B_clean$EMPLOYMENT_END_DATE, format = "%m/%d/%y")

#create new variable "Wait_Time", representing wait time between decision date and submitted date
H1B_clean$Wait_Time <- H1B_clean$DECISION_DATE-H1B_clean$CASE_SUBMITTED
H1B_clean$Wait_Time <-as.numeric(as.character(H1B_clean$Wait_Time))


#add new variables Wait_Time (numeric); Entry_Mistake (logistic); annual_wage (numeric) into data
data<-mutate(data, Wait_Time = H1B_clean$Wait_Time)
data<-mutate(data, Entry_Mistake = H1B_clean$Entry_Mistake)
data<-mutate(data, annual_wage = H1B_clean$annual_wage)

```
Standardize Wage Process:
From Organization for Economic Co-operation and Development Website (https://stats.oecd.org/index.aspx?DataSetCode=ANHRS), we know that the average annual hours actually worked per worker for U.S. in 2017 is 1780 hours; There are 51 weeks between October 1 2017 and September 30 2018 period. 

##save data_clean
```{r}
##save data to csv
write.csv(data,'data_clean.csv')
```


